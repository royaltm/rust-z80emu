RAL 1243
========

RAL 1243 is a fictional computer brought into its virtual existence for the purpose of providing an example on how to implement emulators based on z80emu Z80 CPU emulator.

Usage
-----

To run the emulator with the built-in ex-roms and default 16kb of user RAM and with the CPU clocked at 4MHz:

```
cargo run --example terminal --release
```

To run the emulator with the externally loaded exroms, 48kb RAM and CPU at 8MHz:

```
cargo run --example terminal --release -- examples/ral1243/exroms -m 48 -c 8000
```

Memory
------

The memory map of RAL 1243:

* 0x0000-0x1FFF occupies the ROM kernel.
* 0x2000-0x3FFF occupies a swappable ROM cardridges with user programs or a kernel only accessible RAM page.
* 0x4000-RAMTOP Random Access Memory available for user programs.

Traps:

If the program counter is between 0x0000 and 0x1FFF (inclusive) the RAM page is being swapped into memory area 0x2000 to 0x3FFF (inclusive). Otherwise the currently swapped cardridge ROM is available at this memory page.

I/O
---

I/O is handled by the BUS devices on the system Bus where the following devices are being installed:

Memory controller:
IN  124 - Reads currently swapped in cardridge number.
OUT 124 - Selects one of 256 swappable cardridges to be mapped at the memory page 0x2000-0x3FFF. If the cardridge doesn't exist a 0xFF byte value filled page appears instead.

One PIO Z8420 chip controlls terminal input connected to its Channel A and a terminal output to its Channel B.
The implementation of the PIO chip emulates only input and output channel modes. The bi-directional and control modes are not currently supported.

IN   8 - Reads a character from the terminal (PIO A)
OUT  9 - PIO A channel control
OUT 10 - Outputs a character to the terminal (PIO B)
OUT 11 - PIO B channel control

The terminal input and output availability is controlled by interrupts generated by the PIO chip.

One CTC Z8430 chip controlls 4 timers/counters.
CLK/TRG lines of channels 0 and 2 are connected to a (CPU clock independent) 100µs pulse (10 kHZ) clock.
ZT/CO line of Channel 0 is connected to CLK/TRG line of channel 1.
ZT/CO line of Channel 1 is currently not connected to anything.
ZT/CO line of Channel 2 is connected to CLK/TRG line of channel 3.

IN   4 - CTC channel 0 current counter value
OUT  4 - CTC channel 0 control
IN   5 - CTC channel 1 current counter value
OUT  5 - CTC channel 1 control
IN   6 - CTC channel 2 current counter value
OUT  6 - CTC channel 2 control
IN   7 - CTC channel 3 current counter value
OUT  7 - CTC channel 3 control

The CTC chip may trigger interrupts on 0 countdown.

Interrupts
----------

IM 2 interrupt mode must be always on.

System
------
The RAM memory area mapped between 0x2000 and 0x3FFF is for exclusive use by the ROM kernel only.

The machine stack occupies the last bytes of RAM memory. SP is initiated to the last address of available RAM + 1 after boot.

* RST 00h - A soft system reset.
* RST 08h - Fetches the input character in Accumulator signaling a new character with ZF=0.
            Register A is being modified only on new input.
            Registers HL' are being modified.
            When called with CF=1 waits until the next character, always succeeds.
            When called with CF=0 returns immediately with a possible failure.
* RST 10h - Outputs a single character given in Accumulator signalling the success with ZF=1.
            Registers HL' are being modified.
            When called with CF=0 waits until the character could be buffered, always succeeds.
            When called with CF=1 returns immediately with a possible failure.
* RST 18h - Forwards a call to an address in IX.
* RST 20h - Forwards a call to an address in IY.
* RST 28h - Forwards to one of the syslib functions identified as an 8-bit function vector in the accumulator.
            Modifies A and HL'. Functions may alter more registers.
            For a list of system library routines consult the rom kernel source ral1243/ral1243_rom.rb.
* RST 30h - Forwards a call to an address in HL.
* RST 38h - Back to system menu.
* NMI - Back to system menu if running user code.

Terminal
--------

The terminal forwards any user input to the RAL 1243 PIO input device.

Some of the function keys have special purpose:

* F1 key generates a Z80 NMI signal.
* F4 key generates a Z80 RESET signal.
* F10 key exits the emulator.

Keys wired to input control codes:

* PgUp:      1
* Home:      2
* End:       3
* PgDn:      4
* Ins:       5
* Backspace: 8
* Tab:       9
* Up:       17
* Left:     18
* Down:     19
* Right:    20
* Esc:      27
* Del:     127

Any message from a PIO output device is being forwarded to the console.

Special output control terminal I/O codes:

Move cursor back left: 8

Move cursor to the next line: 10

Clear terminal: 12

Move cursor to the first column: 13

Move cursor to an absolute position: 16 followed by a row index followed by a column index.

Move cursor:

*  17  ↑ up
*  18  ← left
*  19  ↓ down
*  20  → right

Change cursor appearance: 21 followed by a cursor shape number:
* 0 - hidden
* 1 - underscore
* 2 - block
depending on the terminal capability more shapes may be available.
